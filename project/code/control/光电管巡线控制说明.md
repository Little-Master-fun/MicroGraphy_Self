# 光电管巡线控制系统使用说明

## ? 文件结构

```
MicroGraphy2.0/project/code/
├── control/
│   ├── line_tracking_control.h      # 巡线控制头文件
│   └── line_tracking_control.c      # 巡线控制实现文件
├── drivers/
│   ├── driver_photoelectric.h       # 18路光电管驱动头文件
│   ├── driver_photoelectric.c       # 光电管驱动实现
│   ├── driver_motor.h               # 电机驱动（TB67H420FTG）
│   └── driver_motor.c               # 电机驱动实现
└── test/
    ├── test_line_tracking.h         # 巡线测试头文件
    └── test_line_tracking.c         # 巡线测试实现
```

## ? 电机驱动修改说明

### TB67H420FTG 驱动芯片特性

本项目使用 TB67H420FTG 双 H 桥电机驱动芯片，控制方式为：

- **方向控制**：通过 IN1/IN2 GPIO 引脚
- **速度控制**：通过 PWM 引脚

### 控制真值表

| IN1 | IN2 | 电机状态       |
| --- | --- | -------------- |
| 1   | 0   | 正转 (CW)      |
| 0   | 1   | 反转 (CCW)     |
| 0   | 0   | 短路刹车       |
| 1   | 1   | 停止（高阻态） |

### 引脚配置

#### 左电机

- **PWMA**: P5.3 (TCPWM_CH08, 引脚 39)
- **INA1**: P5.1 (引脚 41)
- **INA2**: P5.2 (引脚 40)

#### 右电机

- **PWMA**: P5.4 (TCPWM_CH09, 引脚 38)
- **INA1**: P6.3 (引脚 41)
- **INA2**: P5.0 (引脚 42)

### API 接口

```c
// 初始化电机
motor_status_enum motor_init(void);

// 设置电机速度（有符号PWM，正值正转，负值反转）
motor_status_enum motor_set_pwm(motor_id_enum motor_id, int16 pwm_value);

// 设置双电机速度（用于差速控制）
motor_status_enum motor_set_speed(int16 left_speed, int16 right_speed);

// 直接控制方向和速度
motor_status_enum motor_set_direction_speed(motor_id_enum motor_id, uint8 direction, uint16 speed);

// 紧急刹车
motor_status_enum motor_brake(motor_id_enum motor_id);
```

## ? 巡线控制系统

### 系统特点

1. **双 PID 控制**

   - 直线 PID：小偏差时使用，追求稳定精确
   - 转弯 PID：大偏差时使用，追求快速响应

2. **自适应速度**

   - 根据偏差大小自动减速
   - 大弯道自动降速 50%

3. **丢线处理**
   - 连续丢线检测
   - 按最后方向继续寻找
   - 自动恢复

### 使用示例

```c
#include "line_tracking_control.h"

int main(void)
{
    // 1. 初始化巡线系统
    line_track_init();

    // 2. 设置目标速度（可选）
    line_track_set_speed(300);  // PWM值 100-800

    // 3. 调整PID参数（可选）
    line_track_set_pid_straight(2.5f, 0.01f, 5.0f);  // Kp, Ki, Kd
    line_track_set_pid_turn(4.0f, 0.005f, 8.0f);

    // 4. 启动巡线
    line_track_start();

    // 5. 在定时器中周期调用更新函数（如10ms）
    while(1)
    {
        line_track_update(0.01f);  // dt = 0.01秒
        system_delay_ms(10);
    }

    return 0;
}
```

### 定时器中断方式

```c
// 在定时器中断中调用（推荐方式）
void pit_handler(void)
{
    // 10ms定时器中断
    line_track_update(0.01f);
}
```

## ?? PID 参数调试

### 默认参数

**直线 PID（小偏差）：**

- Kp = 2.5
- Ki = 0.01
- Kd = 5.0

**转弯 PID（大偏差）：**

- Kp = 4.0
- Ki = 0.005
- Kd = 8.0

### 调试建议

1. **Kp（比例）**：影响响应速度

   - 过大：震荡
   - 过小：响应慢

2. **Ki（积分）**：消除稳态误差

   - 过大：超调
   - 过小：有残差

3. **Kd（微分）**：抑制震荡
   - 过大：对干扰敏感
   - 过小：震荡

### 调试模式

```c
// 使用PID调试模式
test_line_tracking_pid_tuning();
```

## ? 调试信息

```c
// 打印调试信息
line_track_print_debug();

// 输出示例：
// [LINE_TRACK] Pos=-45, Err=-0.50, Ctrl=250, L=450, R=150, Lost=0
// Pos: 线位置 (-90~90)
// Err: 归一化偏差 (-1.0~1.0)
// Ctrl: 控制输出（差速值）
// L/R: 左右轮速度
// Lost: 丢线计数
```

## ? 光电管传感器测试

```c
// 仅测试传感器（不控制电机）
test_line_tracking_sensor_only();

// 输出示例：
// Raw: 1234 2345 3456 ... （18个原始ADC值）
// Bin: 000111111110000000   （二值化结果）
// Line Position: -30, Width: 8
```

## ?? 注意事项

1. **安全测试**

   - 先在台架上测试
   - 确认电机方向正确
   - 速度从小到大调整

2. **参数调整顺序**

   - 先调 Kp，获得基本响应
   - 再调 Kd，消除震荡
   - 最后调 Ki，消除稳态误差

3. **速度限制**

   - 初始速度建议 100-200
   - 调试好后逐步提高到 300-500
   - 最大不超过 800

4. **环境要求**
   - 赛道黑线宽度适中（2-5cm）
   - 光照均匀
   - 黑白对比度好

## ? 常见问题

### Q1: 电机不转或方向错误？

**A**: 检查 IN1/IN2 引脚定义，可能需要交换。

### Q2: 巡线不稳定，左右摆动？

**A**:

- 降低 Kp 值
- 增加 Kd 值
- 降低速度

### Q3: 弯道冲出去？

**A**:

- 增大转弯 PID 的 Kp
- 降低速度
- 调整前瞻距离

### Q4: 丢线频繁？

**A**:

- 检查光电管阈值
- 降低速度
- 调整传感器高度

## ? 参考资料

- TB67H420FTG 数据手册
- Dog 项目巡线算法
- PID 控制原理

## ? 更新记录

- **2025-11-05 v1.0**: 初始版本，实现基本巡线功能
