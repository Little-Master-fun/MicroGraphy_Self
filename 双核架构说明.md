# 双核导航系统架构说明

## ? 概述

本系统采用 CYT4BB 双核架构，将数据采集、底层控制和导航算法分离到两个 CM7 核心上，实现高效的并行处理。

---

## ?? 系统架构

### **CM7_0 核心：数据采集与底层控制**

负责实时性要求高的底层任务：

| 任务          | 周期 | 功能                         |
| ------------- | ---- | ---------------------------- |
| IMU 数据采集  | 1ms  | 读取陀螺仪、加速度计原始数据 |
| AHRS 姿态解算 | 1ms  | 互补滤波姿态解算，输出欧拉角 |
| 电机控制      | 2ms  | PID 闭环控制，PWM 输出       |
| 数据共享      | 5ms  | 将传感器数据发送给 CM7_1     |

### **CM7_1 核心：导航算法与决策**

负责计算密集型的高层任务：

| 任务     | 周期  | 功能                       |
| -------- | ----- | -------------------------- |
| 导航算法 | 5ms   | 路径跟踪、轨迹规划         |
| 控制决策 | 5ms   | 计算目标速度，发送给 CM7_0 |
| 状态监控 | 100ms | 导航状态输出               |

---

## ? 核间通信机制

### 通信方式

使用**共享内存 + IPC 中断**方式实现高效通信：

1. **共享内存区域**：

   - `shared_core0_data`：CM7_0 写入，CM7_1 读取（传感器数据）
   - `shared_core1_data`：CM7_1 写入，CM7_0 读取（控制指令）

2. **IPC 消息通知**：
   - `IPC_MSG_SENSOR_DATA_READY`：传感器数据就绪
   - `IPC_MSG_CONTROL_DATA_READY`：控制数据就绪
   - `IPC_MSG_CORE1_INIT_DONE`：CM7_1 初始化完成

### 数据流向

```
CM7_0核心                           CM7_1核心
┌─────────────────┐                ┌─────────────────┐
│ IMU传感器       │                │                 │
│  ↓              │                │                 │
│ AHRS姿态解算    │                │                 │
│  ↓              │                │                 │
│ 编码器数据      │                │                 │
│  ↓              │   共享内存      │                 │
│ shared_core0    │ ───────────→   │ 导航算法        │
│                 │                │  ↓              │
│                 │                │ 速度决策        │
│                 │   共享内存      │  ↓              │
│ 电机控制        │ ←───────────   │ shared_core1    │
│  ↓              │                │                 │
│ PWM输出         │                │                 │
└─────────────────┘                └─────────────────┘
```

---

## ? 文件结构

### 新增文件

```
project/code/drivers/
├── dual_core_comm.h      # 双核通信头文件（数据结构定义）
└── dual_core_comm.c      # 双核通信实现文件（IPC + 共享内存）

project/user/
├── main_cm7_0.c          # CM7_0主函数（数据采集）
├── main_cm7_1.c          # CM7_1主函数（导航算法）
├── cm7_0_isr.c           # CM7_0中断服务函数
└── cm7_1_isr.c           # CM7_1中断服务函数
```

### 修改文件

- `cm7_0_isr.c`：移除导航算法，添加数据共享
- `cm7_1_isr.c`：添加导航算法执行

---

## ? 使用方法

### 1. 编译配置

确保两个核心的工程都包含以下文件：

- `dual_core_comm.h`
- `dual_core_comm.c`

### 2. 启动流程

**Step 1**: CM7_0 核心启动

```c
// 1. 初始化双核通信
dual_core_comm_init_core0();

// 2. 初始化底层硬件
motor_pid_init();
motor_init();
encoder_init();
ahrs_complementary_init();

// 3. 启动定时器中断
pit_ms_init(PIT_CH2, 1);  // IMU数据采集
pit_ms_init(PIT_CH1, 2);  // 电机控制
pit_ms_init(PIT_CH0, 5);  // 数据共享
```

**Step 2**: CM7_1 核心启动

```c
// 1. 初始化双核通信
dual_core_comm_init_core1();

// 2. 初始化导航系统
nav_ahrs_init();

// 3. 生成路径
test_nav_ahrs_generate_straight_path(2.0f, 0.0f);  // 2米直线
// 或
test_nav_ahrs_generate_square_path(1.0f);  // 1米正方形

// 4. 启动导航
pit_ms_init(PIT_CH0, 5);  // 导航算法
nav_ahrs_set_speed(2.5f);
nav_ahrs_set_mode(NAV_AHRS_MODE_REPLAY);
```

### 3. 路径配置

在 `main_cm7_1.c` 中选择路径类型：

```c
// 方式1: 直线路径
test_nav_ahrs_generate_straight_path(2.0f, 0.0f);  // 2米, 0度

// 方式2: 正方形路径
test_nav_ahrs_generate_square_path(1.0f);  // 1米×1米
```

---

## ?? 共享数据结构

### CM7_0 → CM7_1 (传感器数据)

```c
typedef struct {
    float yaw;              // 偏航角 (度)
    float pitch;            // 俯仰角 (度)
    float roll;             // 横滚角 (度)
    float gyro_z;           // Z轴角速度 (度/秒)
    float position_x;       // X位置 (mm)
    float position_y;       // Y位置 (mm)
    float distance;         // 累计距离 (mm)
    float velocity;         // 当前速度 (m/s)
    int32 encoder_left;     // 左编码器计数
    int32 encoder_right;    // 右编码器计数
    uint8 data_valid;       // 数据有效性
    uint32 timestamp;       // 时间戳
} core0_to_core1_data_t;
```

### CM7_1 → CM7_0 (控制指令)

```c
typedef struct {
    float target_speed_left;    // 左轮目标速度 (m/s)
    float target_speed_right;   // 右轮目标速度 (m/s)
    uint8 control_mode;         // 控制模式
    uint8 nav_running;          // 导航运行状态
    uint16 current_path_index;  // 当前路径点索引
    uint8 data_valid;           // 数据有效性
    uint32 timestamp;           // 时间戳
} core1_to_core0_data_t;
```

---

## ? 优势分析

### 1. **性能提升**

- ? 数据采集和导航算法并行执行
- ? 避免单核心计算瓶颈
- ? 实时性更好

### 2. **模块化设计**

- ? 底层控制和高层决策分离
- ? 便于独立调试和优化
- ? 代码更清晰易维护

### 3. **可扩展性**

- ? 易于添加新的传感器（在 CM7_0）
- ? 易于添加新的导航算法（在 CM7_1）
- ? 共享数据结构易于扩展

---

## ? 调试建议

### 1. 查看启动日志

两个核心都会输出启动信息：

```
[CM7_0] 初始化双核通信...
[CM7_0] 初始化电机控制...
[CM7_0] 初始化完成！
[CM7_1] 初始化双核通信...
[CM7_1] 初始化导航系统...
[CM7_1] 启动导航模式...
```

### 2. 监控导航状态

CM7_1 每秒输出导航状态：

```
[CM7_1] 导航状态: 模式=2, 路径点=50/200
```

### 3. 检查共享数据

可以在调试器中查看：

- `shared_core0_data`：传感器数据
- `shared_core1_data`：控制指令
- `core0_data_ready`：数据就绪标志
- `core1_data_ready`：数据就绪标志

---

## ? 时序分析

### CM7_0 核心时序

```
时间轴：   0ms    1ms    2ms    3ms    4ms    5ms
         │      │      │      │      │      │
IMU:     ├──────┼──────┼──────┼──────┼──────┤  (1ms)
         │      │      │      │      │      │
电机:    │      ├─────────────┼─────────────┤  (2ms)
         │      │      │      │      │      │
共享:    ├─────────────────────────────────┤  (5ms)
```

### CM7_1 核心时序

```
时间轴：   0ms              5ms             10ms
         │                │                │
导航:    ├────────────────┼────────────────┤  (5ms)
         │                │                │
状态:    ├────────(100ms)────────┤            (100ms)
```

---

## ?? 注意事项

1. **启动顺序**：确保 CM7_0 先启动，CM7_1 延迟 2 秒后启动
2. **共享内存访问**：使用`volatile`关键字确保数据同步
3. **IPC 消息**：确保 IPC 端口配置正确（CM7_0 使用 PORT_1，CM7_1 使用 PORT_2）
4. **定时器配置**：两个核心使用不同的 PIT 通道

---

## ? 支持

如有问题，请检查：

1. 编译时是否包含所有必需的文件
2. 两个核心是否都正确启动
3. IPC 通信是否正常工作
4. 共享内存区域是否正确配置

---

**版本**: v1.0  
**日期**: 2025-01-XX  
**作者**: AI Assistant
