# MicroGraphy2.0 引脚配置汇总（已更新 - 2025-11-05）

## 1. 电机驱动引脚 (driver_motor.h)

### 左电机 (双 PWM 控制)

- **正转 PWM 通道**: `TCPWM_CH08_P05_3` (MOTOR_LEFT_PWM1) ? **已更新**
- **反转 PWM 通道**: `TCPWM_CH07_P05_2` (MOTOR_LEFT_PWM2) ? **已更新**
- **备用 PWM 通道**: `TCPWM_CH06_P05_1` (MOTOR_LEFT_PWM3) ? **新增**

### 右电机 (双 PWM 控制)

- **正转 PWM 通道**: `TCPWM_CH09_P05_4` (MOTOR_RIGHT_PWM1) ? **已更新**
- **反转 PWM 通道**: `TCPWM_CH05_P05_0` (MOTOR_RIGHT_PWM2) ? **已更新**
- **备用 PWM 通道**: `TCPWM_CH17_P06_3` (MOTOR_RIGHT_PWM3) ? **新增**

### 开关输入

- **开关 1**: `P21_5` (SWITCH1)
- **开关 2**: `P21_6` (SWITCH2)

---

## 2. 编码器引脚 (driver_encoder.h)

### 左编码器（原理图 H12 - PZ254V-12-6P）

- **编码器接口**: `TC_CH07_ENCODER` (ENCODER_LEFT) ? **已修正**
- **A 相引脚**: `TC_CH07_ENCODER_CH1_P07_6` / `P7.6` ? **已修正**（对应 H12 引脚 2）
- **B 相引脚**: `TC_CH07_ENCODER_CH2_P07_7` / `P7.7` ? **已修正**（对应 H12 引脚 3）

### 右编码器（原理图 H13 - PZ254V-12-6P）

- **编码器接口**: `TC_CH21_ENCODER` (ENCODER_RIGHT) ? **已修正**
- **A 相引脚**: `TC_CH21_ENCODER_CH1_P08_2` / `P8.2` ? **已修正**（对应 H13 引脚 2）
- **B 相引脚**: `TC_CH21_ENCODER_CH2_P08_3` / `P8.3` ? **已修正**（对应 H13 引脚 3）

---

## 3. IMU 传感器引脚 (driver_sch16tk10.c 和 driver_sch16tk10.h)

### SPI 接口配置（根据原理图 U42）

- **SPI 通道**: `SPI_2`
- **MISO**: `SPI2_MISO_P07_0` / `P7.0` ? **已修正**（MCU 引脚 41）
- **MOSI**: `SPI2_MOSI_P07_2` / `P7.2` ? **已修正**（MCU 引脚 42）
- **SCK**: `SPI2_CLK_P07_3` / `P7.3` ? **已修正**（MCU 引脚 43）
- **CS**: `SPI2_CS0_P07_4` / `P7.4` ? **已修正**（MCU 引脚 44）

### 控制引脚

- **外部复位**: `P07_5` (EXTRESN_PORT) ? **已修正**（MCU 引脚 45）
- **备用复位**: `P07_5` (GPIO_RESET) ? **已修正**

---

## 配置参数

### 电机参数

- PWM 频率: 17000 Hz
- PWM 最大值: 3000
- PWM 最小值: 10

### 编码器参数

- 采样时间: 2 ms
- 每转脉冲数: 2900
- 车轮直径: 20.0 mm
- 齿轮减速比: 1.0

### IMU 参数

- SPI 速度: 10 MHz
- 采样定时器: PIT_CH0

### 无线串口参数

- 串口号: UART_1
- 波特率: 115200
- 缓冲区大小: 64 字节

---

## 4. 无线串口模块引脚 (driver_wireless_uart.h)

### 基本通信引脚（根据原理图 U41）

- **串口通道**: `UART_1` ? **已更新**
- **TX 引脚**: `UART1_TX_P04_1` / `P4.1` ? **已更新**（对应 U41 引脚 3）
- **RX 引脚**: `UART1_RX_P04_0` / `P4.0` ? **已更新**（对应 U41 引脚 1）
- **RTS 引脚**: `P22_6` ? **已更新**（对应 U41 引脚 2）
- **CTS 引脚**: `P22_5` ? **已更新**（对应 U41 引脚 8）

---

## 5. 屏幕模块引脚 (driver_screen.h/c) - PZ254V-11-08P

### SPI 接口配置（根据原理图 H9）

- **SPI 通道**: `SPI_1` ? **新增**
- **SCK 引脚**: `SPI1_CLK_P12_4` / `P12.4` ? **新增**（对应 H9 引脚 3）
- **MOSI 引脚**: `SPI1_MOSI_P12_1` / `P12.1` ? **新增**（对应 H9 引脚 2）
- **DC 引脚**: `P22_3` ? **新增**（对应 H9 引脚 4，数据/命令选择）
- **CS 引脚**: `P12_3` ? **新增**（对应 H9 引脚 5，片选）
- **RST/BL 引脚**: `P11_0` ? **新增**（对应 H9 引脚 7，复位或背光）

### 屏幕参数

- 型号: PZ254V-11-08P (2.54 寸 TFT)
- 分辨率: 240x320 (可能需要根据实际调整)
- 驱动 IC: ST7789 / ILI9341 (兼容)
- SPI 速度: 30 MHz

---

## 6. 光电管阵列引脚 (driver_photoelectric.h/c)

### 18 路光电传感器配置

| 通道 | MCU 引脚 | 功能说明      |
| ---- | -------- | ------------- |
| CH0  | P18.0    | 光电管通道 0  |
| CH1  | P19.0    | 光电管通道 1  |
| CH2  | P19.1    | 光电管通道 2  |
| CH3  | P19.2    | 光电管通道 3  |
| CH4  | P19.3    | 光电管通道 4  |
| CH5  | P19.4    | 光电管通道 5  |
| CH6  | P19.5    | 光电管通道 6  |
| CH7  | P19.6    | 光电管通道 7  |
| CH8  | P20.7    | 光电管通道 8  |
| CH9  | P21.0    | 光电管通道 9  |
| CH10 | P21.1    | 光电管通道 10 |
| CH11 | P21.2    | 光电管通道 11 |
| CH12 | P21.3    | 光电管通道 12 |
| CH13 | P21.4    | 光电管通道 13 |
| CH14 | P21.5    | 光电管通道 14 |
| CH15 | P21.6    | 光电管通道 15 |
| CH16 | P21.7    | 光电管通道 16 |
| CH17 | P22.0    | 光电管通道 17 |

### 功能特性

- **通道数量**: 18 路
- **数据输出**: 位图格式 + 独立通道
- **位置计算**: 加权平均算法（-1.0 ~ 1.0）
- **线宽检测**: 自动计算检测到的线宽
- **有效性判断**: 自动判断数据是否有效

---

## 7. 按键输入引脚 (driver_key.h/c)

### 8 路按键配置

| 按键 | MCU 引脚 | 备注说明                 |
| ---- | -------- | ------------------------ |
| KEY0 | P20.0    | 通过 470Ω 电阻，上拉输入 |
| KEY1 | P1.1     | 上拉输入                 |
| KEY2 | P1.0     | 上拉输入                 |
| KEY3 | P20.1    | 通过 470Ω 电阻，上拉输入 |
| KEY4 | P20.2    | 通过 470Ω 电阻，上拉输入 |
| KEY5 | P0.3     | 上拉输入                 |
| KEY6 | P1.1     | 上拉输入（与 KEY1 共用） |
| KEY7 | P20.3    | 通过 470Ω 电阻，上拉输入 |

### 功能特性

- **按键数量**: 8 路
- **消抖时间**: 20ms（可配置）
- **长按检测**: 1000ms（可配置）
- **事件类型**: 按下、释放、单击、长按
- **回调支持**: 支持注册回调函数
- **状态机设计**: 稳定可靠的按键检测

---

## 修改记录

### 2025-11-05 更新

根据新原理图 `SCH_原理图_2025-11-04.pdf` 完成以下引脚配置更新：

#### 1. 电机驱动引脚变更 ?

- **左电机**：P05_3, P05_2, P05_1（原 P03_1, P03_0）
- **右电机**：P05_4, P05_0, P06_3（原 P02_3, P02_4）
- 新增第三个 PWM 通道支持

#### 2. 编码器引脚变更 ?（已根据原理图修正）

- **左编码器（H12）**：P7.6, P7.7（原理图确认）
- **右编码器（H13）**：P8.2, P8.3（原理图确认）

#### 3. IMU 传感器引脚变更 ?（已根据原理图 U42 修正）

- **SPI 引脚**：P7.0（MISO）, P7.2（MOSI）, P7.3（SCK）, P7.4（CS）
- **复位引脚**：P7.5（EXTRESN）
- **对应 MCU 引脚**：41（MISO）, 42（MOSI）, 43（SCK）, 44（CS）, 45（EXTRESN）

#### 4. 无线串口模块引脚（原理图 U41）?

- **TX/RX 引脚**：P4.1（TX）, P4.0（RX）- 保持原配置
- **RTS 引脚**：P22.6 - 保持原配置
- **CTS 引脚**：P22.5 - 新增

#### 5. 屏幕模块引脚（原理图 H9）?

- **SPI 引脚**：P12.1（MOSI）, P12.4（SCK）- 新增
- **控制引脚**：P22.3（DC）, P12.3（CS）, P11.0（RST/BL）- 新增
- **型号**：PZ254V-11-08P (2.54 寸 TFT)

#### 修改的文件

1. `MicroGraphy2.0/project/code/drivers/driver_motor.h` - 电机 PWM 引脚
2. `MicroGraphy2.0/project/code/drivers/driver_encoder.h` - 编码器引脚
3. `MicroGraphy2.0/project/code/drivers/driver_sch16tk10.c` - IMU SPI 引脚
4. `MicroGraphy2.0/project/code/drivers/driver_sch16tk10.h` - IMU SPI 引脚
5. `MicroGraphy2.0/project/code/drivers/driver_wireless_uart.h` - 无线串口引脚
6. `MicroGraphy2.0/project/code/drivers/driver_screen.h` - 屏幕驱动（新增）
7. `MicroGraphy2.0/project/code/drivers/driver_screen.c` - 屏幕驱动（新增）
8. `MicroGraphy2.0/project/code/drivers/driver_photoelectric.h` - 光电管驱动（新增）
9. `MicroGraphy2.0/project/code/drivers/driver_photoelectric.c` - 光电管驱动（新增）
10. `MicroGraphy2.0/project/code/drivers/driver_key.h` - 按键驱动（新增）
11. `MicroGraphy2.0/project/code/drivers/driver_key.c` - 按键驱动（新增）

---

## 注意事项

1. **电机驱动**：新增了第三个 PWM 通道（MOTOR_LEFT_PWM3 和 MOTOR_RIGHT_PWM3），如电机驱动模块需要使能信号，可使用这些引脚。
2. **编码器**：编码器通道号已更新，左编码器使用 TC_CH35，右编码器使用 TC_CH00。
3. **IMU 传感器**：SPI 引脚全部更新到 P13 端口，确保硬件连接正确。
4. **编译测试**：修改完成后，请编译项目并测试各模块功能是否正常。

---

## 引脚对照表

| 模块            | 功能         | 新引脚            | 旧引脚            |
| --------------- | ------------ | ----------------- | ----------------- |
| 左电机 PWM 控制 | PWM1/IN1     | P5.3 (TCPWM_CH08) | P3.1 (TCPWM_CH00) |
| 左电机 PWM 控制 | PWM2/IN2     | P5.2 (TCPWM_CH07) | P3.0 (TCPWM_CH01) |
| 左电机 PWM 控制 | PWM3         | P5.1 (TCPWM_CH06) | -                 |
| 右电机 PWM 控制 | PWM1/IN1     | P5.4 (TCPWM_CH09) | P2.3 (TCPWM_CH04) |
| 右电机 PWM 控制 | PWM2/IN2     | P5.0 (TCPWM_CH05) | P2.4 (TCPWM_CH03) |
| 右电机 PWM 控制 | PWM3         | P6.3 (TCPWM_CH17) | -                 |
| 左编码器 (H12)  | A 相         | P7.6 (TC_CH07)    | -（原理图确认）   |
| 左编码器 (H12)  | B 相         | P7.7 (TC_CH07)    | -（原理图确认）   |
| 右编码器 (H13)  | A 相         | P8.2 (TC_CH21)    | -（原理图确认）   |
| 右编码器 (H13)  | B 相         | P8.3 (TC_CH21)    | -（原理图确认）   |
| IMU (SCH16T)    | SPI_CS       | P13.0 (SPI2_CS0)  | P15.3 (SPI2_CS0)  |
| IMU (SCH16T)    | SPI_SCK      | P13.1 (SPI2_CLK)  | P15.2 (SPI2_CLK)  |
| IMU (SCH16T)    | SPI_MISO     | P13.2 (SPI2_MISO) | P15.0 (SPI2_MISO) |
| IMU (SCH16T)    | SPI_MOSI     | P13.3 (SPI2_MOSI) | P15.1 (SPI2_MOSI) |
| IMU (SCH16T)    | 复位 EXTRESN | P13.4             | P14.1             |
| 无线串口模块    | TX           | P4.1 (UART1_TX)   | 保持不变          |
| 无线串口模块    | RX           | P4.0 (UART1_RX)   | 保持不变          |
| 无线串口模块    | RTS          | P22.6             | 保持不变          |
| 无线串口模块    | CTS          | P22.5             | -（新增）         |
| 屏幕模块 (H9)   | SPI_SCK      | P12.4 (SPI1_CLK)  | -（新增）         |
| 屏幕模块 (H9)   | SPI_MOSI     | P12.1 (SPI1_MOSI) | -（新增）         |
| 屏幕模块 (H9)   | DC           | P22.3             | -（新增）         |
| 屏幕模块 (H9)   | CS           | P12.3             | -（新增）         |
| 屏幕模块 (H9)   | RST/BL       | P11.0             | -（新增）         |
